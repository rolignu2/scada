<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Process Flow</title>
<meta name="description" content="A simple process flow or SCADA diagram editor, simulating equipment monitoring and control." />
<!-- Copyright 1998-2017 by Northwoods Software Corporation. -->
<meta charset="UTF-8">
<script src="go.js"></script>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">


<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

<script
  src="https://code.jquery.com/jquery-3.2.0.js"
  integrity="sha256-wPFJNIFlVY49B+CuAIrDr932XSb6Jk3J1M22M3E2ylQ="
  crossorigin="anonymous"></script> 

  <script src="GuideLines.js"></script>
  
 <style>
 
 div#scada-show > a {
    color: blue;
    text-decoration: blink;
    margin-left: 2.5px;
}



<style type="text/css">
#menuBar {
  border: none;
  border: 0px;
  margin: 0px;
  padding: 0px;
  font: 67.5% 'Lucida Sans Unicode', 'Bitstream Vera Sans', 'Trebuchet Unicode MS', 'Lucida Grande', Verdana, Helvetica, sans-serif;
  font-size: 12px;
  font-weight: bold;
  width: auto;
}
#menuBar ul {
  background: #ededed;
  height: 25px;
  list-style: none;
  margin: 0;
  padding: 0;
}
#menuBar li {
  float: left;
  padding: 0px;
}
#menuBar li a {
  background: #ededed;
  display: block;
  font-weight: normal;
  line-height: 25px;
  margin: 0px;
  padding: 0px 5px;
  text-align: center;
  text-decoration: none;
}
#menuBar > ul > li > a {
  color: black;
}
#menuBar ul ul a {
  color: black;
}
#menuBar li > a:hover,
#menuBar ul li:hover > a {
  background: #007FFF;
  color: white;
  text-decoration: none;
}
#menuBar li ul {
  background: #9CCB19;
  display: none;
  height: auto;
  padding: 0px;
  margin: 0px;
  border: 0px;
  position: absolute;
  width: 150px;
  z-index: 200;
}
#menuBar li:hover ul {
  display: block;
}
#menuBar li li {
  background: #ededed;
  display: block;
  float: none;
  margin: 0px;
  padding: 0px;
  width: 150px;
}
#menuBar li:hover li a {
  background: none;
}
#menuBar li ul a {
  display: block;
  height: 25px;
  font-size: 12px;
  font-style: normal;
  margin: 0px;
  padding: 0px 10px 0px 15px;
  text-align: left;
}
#menuBar li ul a:hover,
#menuBar li ul li:hover > a {
  background: #007FFF;
  border: 0px;
  color: white;
  text-decoration: none;
}
/*sub-sublist*/
#nav li:hover ul ul {
	display: none;
}
#nav li li:hover ul {
	background:#9CCB19;
	margin-left: 150px;
	margin-top: -25px;
	display: block;
}
/*sub-sub-sublist*/
#nav li li:hover ul ul {
	display: none;
}
#nav li li li:hover ul {
	background:#9CCB19;
	margin-left: 150px;
	margin-top: -25px;
	display: block;
	color: #0276FD;
}
	input {
		text-align: center;
		font-size: large;
		float: left;
	}
	#myOverviewDiv {
		background-color: lightgray;
	}
	#currentFile {
		background: #1874CD;
		width:100%;
		text-align:center;
		font-family:Arial;
		font-weight:bold;
		font-size:14px;
		padding:3px 0px;
		color: white;
	}
	.draggable {
		display: inline-block;
		vertical-align: top;
		border: 1px solid gray;
		background-color: #e2e2e2;

		position: absolute;
		top:40%;
		left:50%;
		width:300px;
		height: 200px;
		z-index: 500;
	}
	.handle {
		    background-color: darkblue;
			color: white;
		text-align: center;
		font: bold 12px sans-serif;
	}
	.elementText {
		font-family:Arial;
		font-size:medium;
		margin-left: 10px;
		margin-top: 20px;
		margin-bottom:10px;
	}
	.mySavedFiles {
		font-family:Arial;
		font-size:medium;
		width:250px;
		margin-left: 25px;
	}
	.elementBtn {
		margin-top:20px;
		font-family:Arial;
		font-size:medium;
		margin-left:20px;
	}
</style>

 
 
 </style>


</head>


<body>

	

<div>
	<div id="currentFile">
		 (nombre del proyecto)
	</div>
	<div id="menuBar">
	<ul id="nav">
		<li><a href="#">Archivo</a>
			<ul>
				<li><a href="#" onclick="saveDocumentAs()">Guardar</a></li>
				<li><a href="#" onclick="removeDocument()">Eliminar Proyecto</a></li>
			</ul>
		</li>
		<li><a href="#" onclick="">Monitoreo</a></li>
	</ul>
	</div><!--END menu bar -->

	<div id="PaletteAndDiagram" style="position: relative; overflow: hidden; width: 100%;">
		<div style="display:none;" id='scada-show'>
			<a id="scada-show-more" class="" href="javascript:void(0);" >
				<i  style="cursor:pointer;" class="fa fa-plus" aria-hidden="true">
				</i>
			</a>
			<a  id="scada-delete-node" class="" href="javascript:void(0);" >
				<i  style="cursor:pointer;" class="fa fa-trash" aria-hidden="true">
				</i>
			</a>
</div>
	
	
		<div id="sideBar" style="float:left; width:23%; min-height: 500px; text-align:center">
			<div class="handle">Controles Principales</div>
			<div id="controls" style="border:solid 1px gray; width: 100%; min-height: 300px"></div>
			<div class="handle">Otros Controles</div>
			<div id="controls-pipes" style="border:solid 1px gray; width: 100%; min-height: 500px"></div>
			<div class="handle">Vista</div>
			<div id="overview" style="border:solid 1px gray; width: 100%; height:225px;"></div>
		</div>
		<div id="frame" style="position: absolute; border: solid 1px gray; width:77%; height: 100%; min-height:500px; margin-left:23%; background-color:white"></div>
	</div>


	

</div>


	
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>



<script>

	var $temp = null;

	class ScadaError {
	
			ObjectError(name , type ){
				  console.log("ERROR -> " + name  + " T ->" + type );
			}
	
	}


	class ScadaTools extends ScadaError  {
	
		constructor(){
			super();
			this.canvasId 		= "frame";
			this.canvasData     = {};
			this.$$ 			= go.GraphObject.make;
			this.canvas 		= null;
			this.controlId		= "controls";
			this.control 		= null ;
			this.pipeId 		= null ;
			this.controlPipe 	= null ;
			this.saveBtn		= "#save_scada";
			this.imgLocation    = "images/{pattern}.png";
			this.modelData		= null;
			this.controlData    = null ;
			this.controlData2   = null ;
			
		}
		
		init(){
		
			//creamos el puntero de go
			
			
			//configuraciones iniciales para el frame tambien llamado canvas 
			this.canvas 		= this.$$(go.Diagram, this.canvasId,
									{
										  grid: this.$$(go.Panel, "Grid",
												this.$$(go.Shape, "LineH", { stroke: "lightgray", strokeWidth: 0.5 }),
												this.$$(go.Shape, "LineH", { stroke: "gray", strokeWidth: 0.5, interval: 10 }),
												this.$$(go.Shape, "LineV", { stroke: "lightgray", strokeWidth: 0.5 }),
												this.$$(go.Shape, "LineV", { stroke: "gray", strokeWidth: 0.5, interval: 10 })
											),
											allowDrop: true, 
											draggingTool: new GuidedDraggingTool(),
											"draggingTool.dragsLink": true,
											"draggingTool.isGridSnapEnabled": true,
											"linkingTool.isUnconnectedLinkValid": true,
											"linkingTool.portGravity": 20,
											"relinkingTool.isUnconnectedLinkValid": true,
											"relinkingTool.portGravity": 20,
											"relinkingTool.fromHandleArchetype":
											this.$$(
													go.Shape, 
													"Diamond", { 
																segmentIndex: 0, 
																cursor: "pointer", 
																desiredSize: new go.Size(8, 8), 
																fill: "tomato",
																stroke: "darkred" 
													}),
											"relinkingTool.toHandleArchetype":
											this.$$(go.Shape, "Diamond", { segmentIndex: -1, cursor: "pointer", desiredSize: new go.Size(8, 8), fill: "darkred", stroke: "tomato" }),
											"linkReshapingTool.handleArchetype":
											this.$$(go.Shape, "Diamond", { desiredSize: new go.Size(7, 7), fill: "lightblue", stroke: "deepskyblue" }),
											//rotatingTool: $(this.TopRotatingTool), 
										   "rotatingTool.snapAngleMultiple": 15,
										   "rotatingTool.snapAngleEpsilon": 15,
										   "undoManager.isEnabled": true
									});
									
			
				
			this.nodeSelectionAdornmentTemplate =
				this.$$(go.Adornment, "Auto",
					this.$$(go.Shape, { 
							fill: null, 
							stroke: "deepskyblue", 
							strokeWidth: 1.5, 
							strokeDashArray: [4, 2] }),
					this.$$(go.Placeholder)
				);
			
			this.nodeResizeAdornmentTemplate =
				this.$$(go.Adornment, "Spot",
				{ locationSpot: go.Spot.Right },
				this.$$(go.Placeholder),
				this.$$(go.Shape, { alignment: go.Spot.TopLeft, cursor: "nw-resize", desiredSize: new go.Size(6, 6), fill: "lightblue", stroke: "deepskyblue" }),
				this.$$(go.Shape, { alignment: go.Spot.Top, cursor: "n-resize", desiredSize: new go.Size(6, 6), fill: "lightblue", stroke: "deepskyblue" }),
				this.$$(go.Shape, { alignment: go.Spot.TopRight, cursor: "ne-resize", desiredSize: new go.Size(6, 6), fill: "lightblue", stroke: "deepskyblue" }),
	
				this.$$(go.Shape, { alignment: go.Spot.Left, cursor: "w-resize", desiredSize: new go.Size(6, 6), fill: "lightblue", stroke: "deepskyblue" }),
				this.$$(go.Shape, { alignment: go.Spot.Right, cursor: "e-resize", desiredSize: new go.Size(6, 6), fill: "lightblue", stroke: "deepskyblue" }),

				this.$$(go.Shape, { alignment: go.Spot.BottomLeft, cursor: "se-resize", desiredSize: new go.Size(6, 6), fill: "lightblue", stroke: "deepskyblue" }),
				this.$$(go.Shape, { alignment: go.Spot.Bottom, cursor: "s-resize", desiredSize: new go.Size(6, 6), fill: "lightblue", stroke: "deepskyblue" }),
				this.$$(go.Shape, { alignment: go.Spot.BottomRight, cursor: "sw-resize", desiredSize: new go.Size(6, 6), fill: "lightblue", stroke: "deepskyblue" })
			);
			
			this.nodeRotateAdornmentTemplate =
			this.$$(go.Adornment,
				{ locationSpot: go.Spot.Center, locationObjectName: "CIRCLE" },
				this.$$(go.Shape, "Circle", { name: "CIRCLE", cursor: "pointer", desiredSize: new go.Size(7, 7), fill: "lightblue", stroke: "deepskyblue" }),
				this.$$(go.Shape, { geometryString: "M3.5 7 L3.5 30", isGeometryPositioned: true, stroke: "deepskyblue", strokeWidth: 1.5, strokeDashArray: [4, 2] })
			);
			
			
			/**
				Creando las plantillas para los objetos SCADA 
			***/
			
			this._TemplateMap  = new go.Map("string", go.Node);
			this._TemplateMap.add("SCADA_A", this._FigureTemplate());
			this._TemplateMap.add("SCADA_B", this._ImageTemplate());
			this._TemplateMap.add("SCADA_PIPE" , this._PipeTemplate());
			this._TemplateMap.add("SCADA_GAUGE_1" , this._GaugeTemplate());
			this._TemplateMap.add("SCADA_GAUGE_2" , this._GaugeTemplate("flow"));
			this.canvas.nodeTemplateMap = this._TemplateMap;

			
	
			this._linkTemplate();  //carga las plantillas 
			this._load(); 		   //carga multiple  
			this._loop();		  //cargar loops 
			this._controlBar();   //cargar el area de controladores 
			this._documentChange(); //carga la funcion change del documento 
			
    }
	
	_ImageTemplate(){
	
		var $this = this;
		return this.$$(go.Node, "Spot",
						{ 
							locationSpot: go.Spot.Center 
						},
						new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
						{ selectable: true, selectionAdornmentTemplate: this.nodeSelectionAdornmentTemplate },
						{ resizable: true, resizeObjectName: "PANEL", resizeAdornmentTemplate: this.nodeResizeAdornmentTemplate },
						{ rotatable: true, rotateAdornmentTemplate: this.nodeRotateAdornmentTemplate },
						new go.Binding("angle").makeTwoWay(),
						this.$$(go.Panel, "Auto",
						{ 
							name: "PANEL" 
						},
						new go.Binding("desiredSize", 
								"size",
								go.Size.parse
						).makeTwoWay(go.Size.stringify),
						this.$$(go.TextBlock, 
								new go.Binding("text", "key")
						),
						this.$$(go.Picture, 
							{ 
								desiredSize: new go.Size(75, 50) 
							},
							new go.Binding("source", "src", 
							function(s) 
							{ 
								return String($this.imgLocation)
											.replace("{pattern}" , s).toString() ; 
							}
						))
					),
						this._makePort("T", go.Spot.Top, false, true  ),
						this._makePort("L", go.Spot.Left, true, true),
						this._makePort("R", go.Spot.Right, true, true),
						this._makePort("B", go.Spot.Bottom, true, false),
						{ 
							mouseEnter: function(e, node ) { scada.showSmallPorts(node, true ); },
							mouseLeave: function(e, node ) { scada.showSmallPorts(node, false ); }
						}
			);
	
	}
	
	
	_FigureTemplate (){
			return this.$$(go.Node, "Spot",
						{ 
							locationSpot: go.Spot.Center 
						},
								new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
								{ 
									selectable: true, 
									selectionAdornmentTemplate: this.nodeSelectionAdornmentTemplate 
								},
								{ 
									resizable: true, 
									resizeObjectName: "PANEL",
									resizeAdornmentTemplate: this.nodeResizeAdornmentTemplate 
								},
								{ 
									rotatable: true, 
									rotateAdornmentTemplate: this.nodeRotateAdornmentTemplate 
								},
						new go.Binding("angle").makeTwoWay(),
						this.$$(go.Panel, "Auto",
						{ 
							name: "PANEL" 
						},
						new go.Binding("desiredSize", "size", go.Size.parse)
													.makeTwoWay(go.Size.stringify),
						this.$$(go.Shape, "Rectangle", 
						{
								portId: "", 
								fromLinkable: true, 
								toLinkable: true, 
								cursor: "pointer",
								fill: "white",  
								strokeWidth: 2,
							},
							new go.Binding("figure"),
							new go.Binding("fill")
						),
						this.$$(go.TextBlock,
							{
								font: "bold 11pt Helvetica, Arial, sans-serif",
								margin: 8,
								maxSize: new go.Size(160, NaN),
								wrap: go.TextBlock.WrapFit,
								editable: true
						},
						new go.Binding("text").makeTwoWay())
					),
						this._makePort("T", go.Spot.Top, false, true  ),
						this._makePort("L", go.Spot.Left, true, true),
						this._makePort("R", go.Spot.Right, true, true),
						this._makePort("B", go.Spot.Bottom, true, false),
						{ 
							mouseEnter: function(e, node ) { scada.showSmallPorts(node, true ); },
							mouseLeave: function(e, node ) { scada.showSmallPorts(node, false ); }
						}
			);
	
	}
	
	_GaugeTemplate( type = "manometer"){
	
	    //template especial para general el sistema de sensores 
		
		var s = "Rectangle";
		var t = "Blue";
		var k = "White"
		
		if(type == "flow"){
			 s= "Circle";
			 t = "Red";
			 k = "Yellow";
		}
		
		
		return  this.$$(go.Node, "Auto",
		{ 
			//resizable: true//,
			locationSpot: go.Spot.Center
		},  
		new go.Binding("angle").makeTwoWay(),	
		new go.Binding('width').makeTwoWay(),
        new go.Binding('height').makeTwoWay(), 
        this.$$(go.Shape, s,
          { 
		    width : 100 ,
			height : 100 ,
			stroke: t, 
			strokeWidth: 0, 
			spot1: go.Spot.TopLeft,
			spot2: go.Spot.BottomRight },
			new go.Binding("stroke", "color")),
			this.$$(go.Panel, "Spot",
            this.$$(go.Panel, "Graduated",
            {
			  width : 95 ,
			  height : 95 ,
              name: "SCALE", 
			  margin: 2,
              graduatedTickUnit: 5,  // tick marks at each multiple of 2.5
              graduatedMax: 100,  // this is actually the default value
              stretch: go.GraphObject.None  // needed to avoid unnecessary re-measuring!!!
            },
      	
            this.$$(go.Shape, {
							width : 90 ,
						    height : 90 ,
							name: "SHAPE", 
							geometryString: "M-70.7 70.7 B135 270 0 0 100 100 M0 100", 
							stroke: k, 
							strokeWidth: 4 
			}),
            // three differently sized tick marks
            this.$$(go.Shape, { 
							width : 5 ,
							height : 5 ,
							geometryString: "M0 0 V10", 
							stroke: k,
							strokeWidth: 1.5 
			}),
            this.$$(go.Shape, {
						width : 5 ,
						height : 5 ,
						geometryString: "M0 0 V12", 
						stroke:k, 
						strokeWidth: 2.5, 
						interval: 2
			}),
			  this.$$(go.Shape, {
						width : 5 ,
						height : 5 ,
						geometryString: "M0 0 V15", 
						stroke: k,
						strokeWidth: 3.5,
						interval: 4 
			}),
            this.$$(go.TextBlock,
              { 
				//width : 5 ,
				//height : 5 ,
                interval: 4,
                alignmentFocus: go.Spot.Center,
                font: "bold italic 5pt sans-serif", stroke: "white",
                segmentOffset: new go.Point(0, 30)
              })
          ),
          this.$$(go.TextBlock,
            { 
					//width : 20 ,
					//height : 20 ,
					alignment: new go.Spot(0.5, 0.9), 
					stroke: k, 
					font: "bold italic 8pt sans-serif" },
					new go.Binding("text", "text"),
					new go.Binding("stroke", "color")),
					this.$$(go.Shape, { 
								width : 80 ,
								//height : 95 ,
								fill: t, 
								strokeWidth: 1,
								geometryString: "F1 M-6 0 L0 -6 100 0 0 6z x M-100 0" 
					},
					new go.Binding("angle", "value", this._convertValueToAngle)),
					this.$$(go.Shape, "Circle", { width: 2, height: 2, fill: "white" })
        ),
		this._makePort("T", go.Spot.Top, false, true  ),
						this._makePort("L", go.Spot.Left, true, true),
						this._makePort("R", go.Spot.Right, true, true),
						this._makePort("B", go.Spot.Bottom, true, false),
						{ 
							mouseEnter: function(e, node ) { scada.showSmallPorts(node, true ); },
							mouseLeave: function(e, node ) { scada.showSmallPorts(node, false ); }
						}
      );

	}
	
   

	_PipeTemplate(){
	
	  function portFigure(pid) {
	  
	  
		if (pid === null || pid === "") return "XLine";
		if (pid[0] === 'F') return "CircleLine";
		if (pid[0] === 'M') return "PlusLine";
		return "XLine";  
		}
		
		return this.$$(go.Node, "Spot",
        {
          locationObjectName: "SHAPE",
          locationSpot: go.Spot.Center,
          selectionAdorned: true , 
          itemTemplate:
            this.$$(go.Panel,
              new go.Binding("portId", "id"),
              new go.Binding("alignment", "spot", go.Spot.parse),
              this.$$(go.Shape, "XLine",
                { width: 6, height: 6, background: "transparent", fill: null, stroke: "gray" },
                new go.Binding("figure", "id", portFigure),  
                new go.Binding("angle", "angle"))
          ),
          linkConnected: function(node, link, port) {
            if (link.category === "") port.visible = false;
          },
          linkDisconnected: function(node, link, port) {
           if (link.category === "") port.visible = true;
          }
        },
       // new go.Binding("itemArray", "ports"),
      //  new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
       // new go.Binding("angle", "angle").makeTwoWay(),
       // new go.Binding("layerName", "isSelected", function(s) { return s ? "Foreground" : ""; }).ofObject(),
       	   this.$$(go.Shape,
          {
            name: "SHAPE",
            geometryString: "F1 M0 0 L20 0 20 20 0 20 z",
            fill: "rgba(128, 128, 128, 0.5)"
          },
          new go.Binding("geometryString", "geo"),
          new go.Binding("stroke", "isSelected", function(s) { return s ? "dodgerblue" : "black"; }).ofObject()
		  )
      );
	
	}
	

	_documentChange($this = this){
	
		this.canvas.addDiagramListener("Modified", function(e) {

			/***
				cuando se modifica el canvas
			****/
		
			let button =	$(scada.saveBtn);
			var idx = document.title.indexOf("*");
			
			if($this.canvas.isModified){
				button.prop("disabled" , false)
				if(idx < 0) document.title += "*";
				else document.title = document.title.substr(0, idx);
			}
			else {
				button.prop("disabled" , true)
			}
			
			
		});
		
		
		this.canvas.addDiagramListener("ExternalObjectsDropped" , function(e ){
		
				/***
					Cuando se agrega un objeto externo al canvas 
					
					al momento de crear el objeto al canvas debe de considerarse 
					un par de cosas , por ejemplo el ID del objeto
				***/
				
				//CANVAS 
				let c = $this.canvas;
				
				//SKIPS 
				let o = c.skipsUndoManager;
				
				
				/**SOLUCION PARA EL SISTEMA DE LINEAS DEL OBJETO **/
				c.links.each(function(l){
				
					 if(l.part.data.sid == null || typeof l.part.data.sid == 'undefined' ){
						l.part.data.sid = $this._CreateOID(l.part.data.type); //CREAMOS UN ID EN LAS LINES 
					 }

					 l.click = function(e,node){
							console.log(node.part.data);
							//let i = $this._CreateOID(node.part.data.type);
							//$this._createModal($this._modalParams(node.part.data));
					 };
					 
				});
				/***FIN DE LA SOLUCION DE LINEAS DE CANVAS ***/
				
				
				/***INICIO PARA LOS DEMAS NODOS ***/
				
				c.nodes.each(function(l){
				
						if(l.part.data.sid == null || typeof l.part.data.sid == 'undefined' ){
							l.part.data.sid = $this._CreateOID(l.part.data.type , l.part.data.category ); //CREAMOS UN ID EN LAS LINES 
						}
						
						l.click = function(e,node){
							console.log(node.part.data);
							console.log(node.part.position);
							console.log($("#scada-show").find("button"));
							
							//$("#scada-show").find("button").position.top = node.part.position.y;
							
							//let i = $this._CreateOID(node.part.data.type);
							//$this._createModal($this._modalParams(node.part.data));
						};
						
						l.contextClick = function(e, node ){ 
							$this._createModal($this._modalParams(node.part.data));
						};
						
						
						//evento mouseover 
						l.mouseOver = function(e,node){
		
							$("#scada-show").css({
								left 		:  node.part.position.x   + 40 ,
								top  		:  (node.part.position.y  -  $("#frame").height()) - 45 ,
								position 	: "relative",
								'z-index'   : '100000000',
								display 	: 'inline',
								opacity     : 0.75
							});
							
							
							//accion scada ver parametros 
							$("#scada-show").find("a[id='scada-show-more']").click(function(){
							
								$this._createModal($this._modalParams(node.part.data));
								
								$("#scada-show").css({
									display : 'none'
								});
								
							});
							
							//accion eliminar el objeto scada
							$("#scada-show").find("a[id='scada-delete-node']").click(function(){
							
								$this._deleteModal(node)
							
								$("#scada-show").css({
									display : 'none'
								});
								
							});
							
						};
						
						
						l.mouseLeave = function(e,node){
							/*$("#scada-show").css({
								display 	: 'none'
							});*/
						}
				
				});
				
				/**FINALIZACION NODAL **/
				
				//e.parameter.click = function(){ console.log("hello");}
				//console.log(c.skipsUndoManager);
		});
	
	}
	
	
	_CreateOID(type = '' , cat = '' , max = 10 , iteration = 0  , r = '' ){
	
		//por medio de esta funcion recursiva podremos crear un ID unico por objeto 
	
		if(max > iteration){
			 return  this._CreateOID(type , cat , max , (iteration+1) , (r + String(Math.floor(Math.random() * 10))));
		}
		else {
		
			let l = String(type).substr(0 , 1 );
			
			if(l == null || l == '' || typeof l == 'undefined' )
				if(cat === 'SCADA_A')
					l = "s";
				else 
					l = "iq";
				
			return  (l  + "_" + r);
		}

	}
	
	_modalParams( data = null  ){
	
		   let _p = {
		   
				text 		: data.text ? data.text : null ,
				name 		: data.name ? data.name : '' ,
				figure 		: data.figure ? data.figure : null ,
				func 		: data.func ? data.func : null ,
				id  		: data.sid ? data.sid : null ,
				type 		: data.type ? data.type : null ,
				state 		: data.state ? data.state : null 
		   };
		   
		   console.log("Console : -> modalParams : \n {Start} ");
		   console.log(_p);
		   console.log("{End}");
		   
		   return _p;
			
	}
	
	_deleteModal(node){
		 
		 let s = $("#scada-modal-delete");
		 let r = s.find(".modal-body").find("p");
		 let p = node.part.data;
		 let i = '';
		 
		 if(p.name == '' || p.name == null  || typeof p.name == 'undefined')
			  i = p.text ;
	     else 
			 i = p.name;
			 
		 let k = 'Â¿Seguro que desea eliminar ' +  i + ' ?';
		 
		 $temp = node.part;
		 $("#delete-action-scada").attr("onclick" , "scada._delAction();");
		 
		
		 r.text(k)
		 s.modal();
		 
	}
	
	_delAction(part = $temp){
		this.canvas.remove(part);
	}
	
	_createModal( $params = null ){
	     
		 //creamos el modal con los parametros necesarios 
		 
		 let s = $("#scada-modal");
		 
		 s.find(".modal-header")
		  .find(".modal-title")
		  .text($params.name);
		
		 s.modal();
	}
	
	_nodeClick(e, node ){
	
		this._createModal(this._modalParams(node.part.data));
	    //nodo en modo onclick 
		/*var n = node.part ;
		 var diagram = n.diagram;
		console.log(diagram); 
		console.log(diagram.model.getCategoryForNodeData(n.data)); //obtenemos la categoria 
		console.log(n.data); //obtenemos la data del nodo 
		n.data.text = "tanquesito";*/
	
	}
	
	
	 /***
	    funcion ciclo A , esta funcion realiza un ciclo por cada 200 milisegundos 
	 *****/
	_loop(){
	
		var diagram = this.canvas;
		var $this = this;
		
		setTimeout(function() {
		
		
			//ciclo para los pipe o tuberias , efecto de agua corriendo 
		    $this._PipeLoop(diagram , $this);
			
			
			
			
			
		    $this._loop();
		}, 200);
	
	}
	
	
	_PipeLoop(diagram , $this ){
	
				try{
						
					var oldskips = diagram.skipsUndoManager;
					diagram.skipsUndoManager = true;
						
					diagram.links.each(function(link) {
					
						var d = link.part.data;	
						var shape = link.findObject("PIPE");
						var off  = 0;
						
						if(d.active != true ) return false;
						
						if(!d.rollback){
							try{
								off = shape.strokeDashOffset - 2;
								shape.strokeDashOffset = (off <= 0) ? 20 : off;
							}
							catch(k){}
						}
						else {
								try{
									off = shape.strokeDashOffset + 2;
									shape.strokeDashOffset = (off <= 0) ? 20 : off;
								}catch(j){}
						}
						
					});
				
				}
				catch(e){
				
				}
			
			diagram.skipsUndoManager = oldskips;
	}
	
	/****
		controlbar primario en configuracion
	****/
	_controlBarConf(){
	
	  
		 this.control =  this.$$(go.Palette, this.controlId ,  
		  {
				maxSelectionCount: 1, 
				nodeTemplateMap: this.canvas.nodeTemplateMap,
				groupTemplate: this.canvas.groupTemplate,
				layout: this.$$(go.GridLayout),
				linkTemplate: 
				this.$$(go.Link,
				{
						locationSpot: go.Spot.Center,
						selectionAdornmentTemplate:
						this.$$(go.Adornment, "Link",
								{ 
										locationSpot: go.Spot.Center 
								},
						this.$$(go.Shape,
							{ 
								isPanelMain: true, 
								fill: null, 
								stroke: "blue", 
								strokeWidth: 0
								
							}),
                    this.$$(go.Shape,  
                      { 
							toArrow: "Standard", 
							stroke: null 
					   })
                  )
              },
              {
                routing: go.Link.AvoidsNodes,
                curve: go.Link.JumpOver,
                corner: 5,
                toShortLength: 10 //,
				//click : function(a,b){ console.log("funcion");}
              },
              new go.Binding("points"),
              this.$$(go.Shape,  
                { 
						isPanelMain: true, 
						strokeWidth: 5
				}),
              this.$$(go.Shape, 
                { 
						toArrow: "Standard",
						stroke: null 
				})
            )
        });
		  
	
	
	}
	
	
	/****
		controlbar secundario 
		se le coloco como pipe porque aca iban a ir una serie de tuberias 
		pero se opto mejor con trabajar con una sola tuberia dinamica o linkbar
	****/
	_controlBarPipe(){
	
		 this.controlPipe =  this.$$(go.Palette, "controls-pipes",  
		  {
				maxSelectionCount: 1, 
				nodeTemplateMap: this.canvas.nodeTemplateMap,
				groupTemplate: this.canvas.groupTemplate,
				layout: this.$$(go.GridLayout),
				linkTemplate: 
				this.$$(go.Link,
				{
						locationSpot: go.Spot.Center,
						selectionAdornmentTemplate:
						this.$$(go.Adornment, "Link",
								{ 
										locationSpot: go.Spot.Center 
								},
						this.$$(go.Shape,
							{ 
								isPanelMain: true, 
								fill: null, 
								stroke: "blue", 
								strokeWidth: 0 
								
							}),
                    this.$$(go.Shape,  
                      { 
							toArrow: "Standard", 
							stroke: null 
					   })
                  )
              },
              {
                routing: go.Link.AvoidsNodes,
                curve: go.Link.JumpOver,
                corner: 5,
                toShortLength: 4 //,
				//click : function(a,b){ console.log("funcion");}
              },
              new go.Binding("points"),
              this.$$(go.Shape,  
                { 
						isPanelMain: true, 
						strokeWidth: 3 
				}),
              this.$$(go.Shape, 
                { 
						toArrow: "Standard",
						stroke: null 
				})
            )
        });
		  
	
	
	}
	
	
	
	/***
		controlbar es una funcion secundaria de carga de objetos a los respectivos 
		sidebars o bars , existen dos tipos de sidebars asi que el controlbar
		debera de llevar dos graph link model 
	****/
	_controlBar(){
	
		 this._controlBarConf();
		 this._controlBarPipe();
		  
		 //PARA CONTROL BAR ESTAS LINEAS DE CODIGO SON LAS BUENAS AHI XD 
		 var line = [
				{
						points: new go.List(go.Point).addAll(
													[	new go.Point(0, 0), 
														new go.Point(30, 0), 
														new go.Point(30, 40), 
														new go.Point(60, 40)
													]),
						type : "line",
						active : true  ,
						rollback : false ,
						func : null , 
						sid  : null
					
				}
			
          ];
		  

		  if(this.controlData === null ){
					this.ObjectError("Error al momento de cargar los items u objetos" , "Load error ");
					return;
		  }
				

		 this.control.model = new go.GraphLinksModel(
			this.controlData,
			line
		 );
		 
		 
		//FIN DE ESAS LINEAS DE CODIGO 
		 
		 
		//CREAR EL OVERVIEW  
		let overView  =
			this.$$(go.Overview, "overview",
					{ observed: this.canvas, maxScale: 0.5 });
					
	
	    //DARLE VIDA AL OVERVIEW 
		overView.box.elt(0).stroke = "dodgerblue";
		
		//veriricando la data del control 2 
		if(this.controlData2 !== null )
				this.controlPipe.model = new go.GraphLinksModel(this.controlData2);
		
		//FIN DE LAS LINEAS DE LOS PIPES 

		

		
	}
	

	

	/***
		Linktemplate es la plantilla que se usa 
		para simular las tuberias en cual recorre el agua 
		asi como su efecto tuberia :D 
	****/

	_linkTemplate(){
	
	 
	
	 this.linkSelectionAdornmentTemplate =
				this.$$(go.Adornment, "Link",
				this.$$(go.Shape,
				{ 
						isPanelMain: true, 
						fill: null, 
						stroke: "deepskyblue", 
						strokeWidth: 0
				})
	 );

	  this.canvas.linkTemplate =
      this.$$(go.Link,
		{ selectable: true, selectionAdornmentTemplate: this.linkSelectionAdornmentTemplate },
        { relinkableFrom: true, relinkableTo: true, reshapable: true },
        { 
				routing: go.Link.AvoidsNodes, 
				curve: go.Link.JumpGap, 
				corner: 10, 
				reshapable: true, 
				toShortLength: 0
		},
        new go.Binding("points").makeTwoWay(),
        this.$$(go.Shape, { isPanelMain: true, stroke: "blue", strokeWidth: 10 }),
        this.$$(go.Shape, { isPanelMain: true, stroke: "blue", strokeWidth: 11 }),
        this.$$(go.Shape, { isPanelMain: true, stroke: "white", strokeWidth: 8, name: "PIPE", strokeDashArray: [11, 11] }),
        this.$$(go.Shape, {  isPanelMain: true , stroke : "blue", fill: "blue", stroke: null , strokeWidth: 8})
      );
	
	
	}
	
	
	_load() {
			//funcion de carga secundaria despues del constructor 
			this.canvas.model = go.Model.fromJson(this.canvasData);
			this.loadDiagramProperties();
	}
	
	
	loadDiagramProperties(e) {
		//carga las propiedades generales del diagrama 
		var pos = this.canvas.model.modelData.position;
		if (pos) this.canvas.initialPosition = go.Point.parse(pos);
    }
		
	
	/***
		funcion de rotacion 
	***/	
	TopRotatingTool() {
			return go.RotatingTool.call(this);
	}
	
	/***
	     esta funcion convierte un valor en un angulo 
		 el angulo es de 0 a 270 radianes entonces 
		 esta funcion se usa para los gauge 
	***/
	_convertValueToAngle(v, shape) {
      var scale = shape.part.findObject("SCALE");
      var p = scale.graduatedPointForValue(v);
      var shape = shape.part.findObject("SHAPE");
      var c = shape.actualBounds.center;
      return c.directionPoint(p);
    }
	
	
	/**
		muestra todos los puertos 
	**/
	showSmallPorts(node, show) {
      node.ports.each(function(port) {
        if (port.portId !== "") { 
          port.fill = show ? "rgba(0,0,0,.3)" : null;
        }
      });
    }
		

	/***
		Crea el sistema de tuberias por medio de un puerto 
		en ellas un to from de la api 
	****/
	_makePort(name, spot, output, input  ) {
			return this.$$(go.Shape, "Circle",
               {
                  fill: null,  
                  stroke: null,
                  desiredSize: new go.Size(7, 7),
                  alignment: spot, 
                  alignmentFocus: spot, 
                  portId: name,  
                  fromSpot: spot, toSpot: spot,  
                  fromLinkable: output, toLinkable: input,  
                  cursor: "pointer" 
               });
	}
		
		
	
}



class Scada extends ScadaTools {
	
	    constructor(){
			super();
		}
		
	
		Create(){
			this.init();
			this.events();
		}
		
		setConfLocale(cnf  ){
		
			
		
			if( cnf == null)  {
					
					this.canvasId 		= "frame";
					this.controlId		= "controls";
					this.saveBtn		= "#save_scada";
					this.imgLocation    = "images/{pattern}.png";
					this.pipeId			= "controls-pipes"
			}
			
		
			if(typeof Cnf !== 'object' ) return null;
			
			if( cnf.canvas !== 'undefined' 
					|| cnf.canvas !== null 
					|| cnf.canvas !== '')
						this.canvasId = cnf.canvas;
			
			if( cnf.control !== 'undefined' 
					|| cnf.control !== null 
					|| cnf.control !== '')
						this.controlId = cnf.control;
			
			if( cnf.savebtn !== 'undefined' 
					|| cnf.savebtn !== null 
					|| cnf.savebtn !== '')
						this.saveBtn = cnf.savebtn;
					
						
			if( cnf.img_location !== 'undefined' 
					|| cnf.img_location!== null 
					|| cnf.img_location !== '')
						this.imgLocation = cnf.img_location;
			
			
			if(typeof cnf.controlPipe !== 'undefined')
					this.pipeID = cnf.controlPipe;
					
	
		
		}
		
		
		events($this = this ){
					
			
			//evento click boton para guardar la data 
			$($this.saveBtn).click(function(){
				$this.modelData = $this.canvas.model.toJson()
				console.log($this.modelData);
			});
			
		}

		 
		addData(data ){
		   this.canvasData = data;
		}
		
		
		setControls (controls = null , controls2 = null ) {
			this.controlData 		= controls;
			this.controlData2 		= controls2;
		}

	
	}

	
	var scada = new Scada();


   $(document).ready(function(){
		//console.log("iniciando...");
		
		
		//scada.addData(data);
		
		scada.setConfLocale({
		
			canvas      	: "frame",
			control     	: "controls",
			savebtn     	: "#save_scada",
			img_location 	: "images/{pattern}.png",
			controlPipe		: "controls-pipes"
			
		});
		
		
		
		let items = [
		
		     {
					text: "Tanque",
					name : "Tank",
					figure: "Cylinder1", 
					fill:  scada.$$(go.Brush, "Linear",
									{ 
										start: go.Spot.Left, 
										end: go.Spot.Right,
									    0: "gray", 
										0.5: "white", 
										1: "gray" 
									}
							),
					minSize				: new go.Size(50, 50),
					fromSpot			: go.Spot.AllSides, 
					toSpot				: go.Spot.AllSides,
					desiredSize 		: new go.Size(35, 35),
					category 			: 'SCADA_A',
					sid 				: null, 
					properties 			: [
						{ name : "variable" ,   value : null , 		func : null  },
						{ name : "position" ,   value : null   , 	func : null  },
						{ name : "active" ,  	value : true  , 	func : null  },	
					    { name : "styles" , 	value : [] , 		func : null},
						{ name : "visible" ,    value : true  ,       func : null },
						{ name : "graph" ,      value : { type : "linear" , data : {}  } , func : null },
						{ personalize : {
								max : 0,
								min : 0,
								type : "tank"
						}}
					]
			 },
			 {
				name 		: "GATO",
				key 		: "gato",
				src 		: "50x40",
				state 		: {
						active : true 
				},
				sid 		: null ,
				func 		: null ,
				category 	: "SCADA_B",
				text 		: ''
			 }
			 
			 
		];
		
		
		let items2 = [
		
            
			 {  
						text: "Flujometro", 
						value: 0 , 
						category:"SCADA_GAUGE_1",
						figure : "flow_sensor",
						name : "Gauge",
						properties : [],
						styles : [],
					    func : null,
					    state : { active : true } , 
						sid : null ,
						width : 100 ,
						height: 100,
						properties 			: [
						{ name : "variable" ,   value : null , 		func : null  },
						{ name : "position" ,   value : null   , 	func : null  },
						{ name : "active" ,  	value : true  , 	func : null  },	
					    { name : "styles" , 	value : [] , 		func : null},
						{ name : "visible" ,    value : true  ,       func : null },
						{ name : "graph" ,      value : { type : "linear" , data : {}  } , func : null },
						{ personalize : {
								max : 0,
								min : 0,
								type : "flow_sensor"
						}},
					]
				},
				
				  
			 {  
						text: "Manometro", 
						value: 0 , 
						category:"SCADA_GAUGE_2",
						figure : "manom_sensor",
						name : "Gauge",
						properties : [],
						styles : [],
					    func : null,
					    state : { active : true } , 
						sid : null ,
						width : 100 ,
						height: 100,
						properties 			: [
						{ name : "variable" ,   value : null , 		func : null  },
						{ name : "position" ,   value : null   , 	func : null  },
						{ name : "active" ,  	value : true  , 	func : null  },	
					    { name : "styles" , 	value : [] , 		func : null},
						{ name : "visible" ,    value : true  ,       func : null },
						{ name : "graph" ,      value : { type : "linear" , data : {}  } , func : null },
						{ personalize : {
								max : 0,
								min : 0,
								type : "flow_sensor"
						}},
					]
				}
				
		
		];
		
		scada.setControls(items , items2 );
		scada.Create();
		
		
   });
   



</script>


</body>
</html>
